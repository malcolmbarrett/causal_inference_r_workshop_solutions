---
title: "Outcome Model"
output: html_document
---


```{r}
library(tidyverse)
library(survey)
library(tableone)
library(broom)
library(cidata)
library(rsample)
```

Using the National Health and Nutrition Examination Survey Data (`nhefs_complete`), we are interested in the relationship between the **exposure**, `qsmk`: whether the participant quit smoking, and the **outcome**, `wt82_71`: their weight change in kilograms.

## Your turn

_After updating the code chunks below, change `eval = TRUE` before knitting._

Create a function called `ipw_fit` that fits the propensity score model from Exercise 03, incorporates the ATE weights calculated in Exercise 04, and fits a weighted outcome model.

```{r, eval = TRUE}
fit_ipw <- function(split, ...) { 
  .df <- analysis(split)
  
  # fit propensity score model
  propensity_model <- glm(
    qsmk ~ age + sex + wt71 + smokeyrs,
    data = .df,
    family = binomial()
  )
  # calculate ATE weights
  
  df <- propensity_model %>%
  augment(type.predict = "response", data = .df) %>%
  mutate(w_ate = 1 / ifelse(qsmk == 0, 1 - .fitted, .fitted))
  
  # fit correctly bootsrapped ipw model 
  lm(wt82_71 ~ qsmk, data = df, weights = w_ate) %>% 
    tidy() 
}
```

Bootstrap this result 1000 times.

```{r, eval = TRUE}
ipw_results <- bootstraps(nhefs_complete, 1000, apparent = TRUE) %>% 
  mutate(results = map(splits, fit_ipw)) 
```


Calculate the confidence interval

```{r, eval = TRUE}
boot_estimate <- int_t(ipw_results, results) %>%
  filter(term == "qsmk")
```


Stretch goal: Do the same for a model using matching.
